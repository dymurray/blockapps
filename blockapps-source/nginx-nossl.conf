
user root;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;

    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    client_body_buffer_size 64K;
    client_header_buffer_size 64k;
    client_max_body_size 1M;
    large_client_header_buffers 4 512k;

    server {
      listen 80;

      resolver 127.0.0.11;

      location / {
        return 302 /dashboard/;
      }

      # explorer legacy
      location /explorer {
        return 302 /dashboard/;
      }

      location = /dashboard {
        return 302 /dashboard/;
      }

      location /dashboard/ {
        auth_basic "Restricted";
        auth_basic_user_file auth.htpasswd;
        proxy_set_header Accept-Encoding "";
        proxy_pass http://smd-ui:3002/;
      }


      location = /apps {
        return 302 /apps/;
      }

      location /apex-api/apps {
        return 302 /apps/;
      }

      location /apps/ {
        proxy_set_header Accept-Encoding "";
        proxy_pass http://apex:3001/apps/;
      }

      location = /apex-api {
        return 302 /apex-api/;
      }

      location /apex-api/ {
        proxy_set_header Accept-Encoding "";
        proxy_pass http://apex:3001/;
        client_max_body_size       100m;

#        limit_except POST          { deny all; }
#        client_body_temp_path      /tmp/;
#        client_body_in_file_only   on;
#        client_body_buffer_size    128K;
#
#        proxy_pass_request_headers on;
#        proxy_set_header           X-FILE $request_body_file;
#        proxy_set_body             off;
#        proxy_redirect             off;
      }

      location /cirrus/contract {
        return 302 /cirrus/contract/;
      }

      location /cirrus/contract/ {
        proxy_set_header Accept-Encoding "";
        proxy_pass http://cirrus:3333/;
      }

      location /cirrus/search {
        return 302 /cirrus/search/;
      }

      location /cirrus/search/ {
        proxy_set_header Accept-Encoding "";
        proxy_pass http://postgrest:3001/;
      }

      location = /bloc/v2.1/ {
        auth_basic "Restricted";
        auth_basic_user_file auth.htpasswd;
        proxy_read_timeout <BLOC_TIMEOUT>s;
        proxy_set_header Accept-Encoding "";
        proxy_pass http://bloch:8000/bloc/v2.1/;
      }

      location /bloc/v2.1/ {
        proxy_read_timeout <BLOC_TIMEOUT>s;
        proxy_set_header Accept-Encoding "";
        proxy_pass http://bloch:8000/bloc/v2.1/;
      }

      location = /bloc/v2.2/ {
        auth_basic "Restricted";
        auth_basic_user_file auth.htpasswd;
        proxy_read_timeout <BLOC_TIMEOUT>s;
        proxy_set_header Accept-Encoding "";
        proxy_pass http://bloch:8000/bloc/v2.2/;
      }

      location /bloc/v2.2/ {
        proxy_read_timeout <BLOC_TIMEOUT>s;
        proxy_set_header Accept-Encoding "";
        proxy_pass http://bloch:8000/bloc/v2.2/;
      }

      location /docs {
         return 302 /docs/;
      }

      location /docs/ {
        auth_basic "Restricted";
        auth_basic_user_file auth.htpasswd;
        proxy_read_timeout 300;
        proxy_set_header Accept-Encoding "";
        proxy_pass http://blockapps-docs:8080/;
      }

      location /bloc/v2.1/docs {
        auth_basic "Restricted";
        auth_basic_user_file auth.htpasswd;
        proxy_read_timeout 300;
        proxy_set_header Accept-Encoding "";
        return 301 /docs/?url=/bloc/v2.1/swagger.json;
      }

      location /bloc/v2.2/docs {
        auth_basic "Restricted";
        auth_basic_user_file auth.htpasswd;
        proxy_read_timeout 300;
        proxy_set_header Accept-Encoding "";
        return 301 /docs/?url=/bloc/v2.2/swagger.json;
      }

      location /strato-api/eth/v1.2/docs {
        auth_basic "Restricted";
        auth_basic_user_file auth.htpasswd;
        proxy_read_timeout 300;
        proxy_set_header Accept-Encoding "";
        return 301 /docs/?url=/strato-api/eth/v1.2/swagger.json;
      }

      location /strato-api/eth/v1.2/swagger.json {
         proxy_pass http://bloch:8002/swagger.json;
      }

      location = /strato-api {
        return 302 /strato-api/;
      }

      location = /strato-api/ {
        auth_basic "Restricted";
        auth_basic_user_file auth.htpasswd;
        proxy_pass http://strato:3000/;
      }

      location /strato-api/ {
        proxy_pass http://strato:3000/;
      }

#      location = /smd {
#        return 302 /smd/;
#      }
#
#      location /smd/ {
#        proxy_read_timeout 300;
#        proxy_set_header Accept-Encoding "";
#        set $grafana http://grafana:3000;
#        proxy_pass $grafana/;
#      }
#
#      location /public/ { # can be removed when i figure out why grafana isnt respecting my base_url
#        proxy_read_timeout 300;
#        proxy_set_header Accept-Encoding "";
#        set $grafana http://grafana:3000;
#        proxy_pass $grafana/;
#      }
    }
}
